<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Window Manager</title>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #FFDCB3;
      font-family: Arial, sans-serif;
      min-height: 100vh;
    }


    .spawn-button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }

    .spawn-button:hover {
      background-color: #FECECE;
      transition: 2s;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .spawn-button:active {
      transform: translateY(0);
      box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2);
    }

    .window-container {
      position: relative;
      width: 100%;
      height: 100vh;
    }

    .window {
      position: absolute;
      background-color: #FFFEE8;
      border: 5px solid #000;
      border-right: 10px solid #000;
      border-bottom: 10px solid #000;
      border-radius: 15px;
      overflow: hidden;
    }

    .window-titlebar {
      background: #FFFEE8;
      border-bottom: 5px solid #000;
      color: black;
      padding: 6px;
      cursor: move;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .window-title {
      flex-grow: 1;
      text-align: center;
      font-weight: 500;
    }

    .window-controls {
      display: flex;
      gap: 8px;
      margin-left: auto;
      padding-left: 4px;
    }

    .window-close {
      width: 16px;
      height: 16px;
      background-color: #FECECE;
      border: 3px solid #000;
      border-radius: 50%;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .window-close:hover {
      background-color: #c0392b;
    }

    .window-content {
      padding: 20px;
      background-color: #ecf0f1;
    }

    .window.active {}

    /* Loading spinner for HTMX */
    .htmx-request .spawn-button {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .htmx-request .spawn-button::after {
      content: "...";
    }
  </style>
</head>

<body>
  <div class="control-panel">
    <button class="spawn-button" hx-post="/window/create" hx-target=".window-container" hx-swap="beforeend">
      Spawn New Window
    </button>
  </div>

  <div class="window-container">
    {{range .Windows}}
    {{template "window" .}}
    {{end}}
  </div>

  <script>
    let draggedElement = null;
    let offsetX = 0;
    let offsetY = 0;
    let highestZIndex = 1000;

    // Use event delegation for dynamically added windows
    document.addEventListener('mousedown', function (e) {
      if (e.target.closest('.window-titlebar')) {
        startDrag(e);
      }
    });

    function startDrag(e) {
      // Find the parent window element
      draggedElement = e.target.closest('.window');
      if (!draggedElement) return;

      const rect = draggedElement.getBoundingClientRect();
      offsetX = e.clientX - rect.left;
      offsetY = e.clientY - rect.top;

      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', stopDrag);

      // Bring element to front
      highestZIndex++;
      draggedElement.style.zIndex = highestZIndex;

      // Add active class
      document.querySelectorAll('.window').forEach(w => w.classList.remove('active'));
      draggedElement.classList.add('active');

      e.preventDefault();
    }

    function drag(e) {
      if (!draggedElement) return;

      let x = e.clientX - offsetX;
      let y = e.clientY - offsetY;

      // Keep window within viewport bounds
      x = Math.max(0, Math.min(x, window.innerWidth - draggedElement.offsetWidth));
      y = Math.max(0, Math.min(y, window.innerHeight - draggedElement.offsetHeight));

      draggedElement.style.left = x + 'px';
      draggedElement.style.top = y + 'px';
    }

    function stopDrag() {
      document.removeEventListener('mousemove', drag);
      document.removeEventListener('mouseup', stopDrag);
      draggedElement = null;
    }

    // Handle window activation on click
    document.addEventListener('click', function (e) {
      const window = e.target.closest('.window');
      if (window) {
        document.querySelectorAll('.window').forEach(w => w.classList.remove('active'));
        window.classList.add('active');
        highestZIndex++;
        window.style.zIndex = highestZIndex;
      }
    });
  </script>
</body>

</html>
