<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Window Manager</title>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #FFDCB3;
      font-family: 'JetBrains Mono', monospace;
      min-height: 100vh;
    }

    :root {
      --outline-color: #282828;
      --secondary-color: #e74c3c;
      --brand-purple: #6c5ce7;
    }


    .lava-lamp-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      /* Allows clicking through to elements below */
      z-index: 1;
      opacity: 0.7;
      /* Adjust opacity for subtlety */
      overflow: hidden;
    }

    /* Individual blob elements */
    .lava-blob {
      position: absolute;
      border-radius: 50%;
    }

    /* Blob 1 - Large, slow-moving */
    .blob-1 {
      width: 600px;
      height: 600px;
      background: #a4dec7;
      /* Turquoise */
      left: -300px;
      top: -300px;
      animation:
        roam-1 120s infinite ease-in-out,
        morph-1 30s infinite ease-in-out;
    }

    /* Blob 2 - Medium, faster */
    .blob-2 {
      width: 400px;
      height: 400px;
      background: #a4dec7;
      /* Turquoise */
      right: -200px;
      top: 50%;
      animation:
        roam-2 90s infinite ease-in-out,
        morph-2 25s infinite ease-in-out;
    }

    /* Blob 3 - Small, dynamic */
    .blob-3 {
      width: 300px;
      height: 300px;
      background: #a4dec7;
      /* Turquoise */
      left: 50%;
      top: -150px;
      animation:
        roam-3 80s infinite ease-in-out,
        morph-3 20s infinite ease-in-out;
    }

    /* Blob 4 - Medium-large, slow */
    .blob-4 {
      width: 500px;
      height: 500px;
      background: #a4dec7;
      /* Turquoise */
      left: 20%;
      bottom: -250px;
      animation:
        roam-4 110s infinite ease-in-out,
        morph-4 40s infinite ease-in-out;
    }

    /* Blob 5 - Small, fast */
    .blob-5 {
      width: 250px;
      height: 250px;
      background: #a4dec7;
      /* Turquoise */
      right: 20%;
      top: 40%;
      animation:
        roam-5 70s infinite ease-in-out,
        morph-5 15s infinite ease-in-out;
    }

    .blob-6 {
      width: 250px;
      height: 250px;
      background: #a4dec7;
      /* Turquoise */
      left: 20%;
      bottom: 40%;
      animation:
        roam-5 70s infinite ease-in-out,
        morph-5 15s infinite ease-in-out;
    }

    /* Roaming animations - full screen movement patterns */
    @keyframes roam-1 {

      0%,
      100% {
        transform: translate(0, 0) rotate(0deg);
      }

      25% {
        transform: translate(400px, 300px) rotate(90deg);
      }

      50% {
        transform: translate(200px, 600px) rotate(180deg);
      }

      75% {
        transform: translate(500px, 400px) rotate(270deg);
      }
    }

    @keyframes roam-2 {

      0%,
      100% {
        transform: translate(0, 0) rotate(0deg);
      }

      20% {
        transform: translate(-300px, -200px) rotate(72deg);
      }

      40% {
        transform: translate(-400px, 200px) rotate(144deg);
      }

      60% {
        transform: translate(-200px, -300px) rotate(216deg);
      }

      80% {
        transform: translate(-100px, 100px) rotate(288deg);
      }
    }

    @keyframes roam-3 {

      0%,
      100% {
        transform: translate(0, 0) rotate(0deg);
      }

      33% {
        transform: translate(-200px, 500px) rotate(120deg);
      }

      66% {
        transform: translate(100px, 300px) rotate(240deg);
      }
    }

    @keyframes roam-4 {

      0%,
      100% {
        transform: translate(0, 0) rotate(0deg);
      }

      25% {
        transform: translate(300px, -400px) rotate(90deg);
      }

      50% {
        transform: translate(100px, -600px) rotate(180deg);
      }

      75% {
        transform: translate(400px, -300px) rotate(270deg);
      }
    }

    @keyframes roam-5 {

      0%,
      100% {
        transform: translate(0, 0) rotate(0deg);
      }

      20% {
        transform: translate(-150px, -100px) rotate(72deg);
      }

      40% {
        transform: translate(200px, -200px) rotate(144deg);
      }

      60% {
        transform: translate(-100px, 150px) rotate(216deg);
      }

      80% {
        transform: translate(150px, 100px) rotate(288deg);
      }
    }

    /* Morph animations - shape distortion */
    @keyframes morph-1 {

      0%,
      100% {
        border-radius: 63% 37% 54% 46% / 55% 48% 52% 45%;
      }

      20% {
        border-radius: 40% 60% 60% 40% / 60% 30% 70% 40%;
      }

      40% {
        border-radius: 45% 55% 30% 70% / 30% 60% 40% 70%;
      }

      60% {
        border-radius: 60% 40% 30% 70% / 50% 60% 40% 50%;
      }

      80% {
        border-radius: 35% 65% 60% 40% / 70% 30% 70% 30%;
      }
    }

    @keyframes morph-2 {

      0%,
      100% {
        border-radius: 70% 30% 46% 54% / 30% 29% 71% 70%;
      }

      25% {
        border-radius: 44% 56% 70% 30% / 69% 46% 54% 31%;
      }

      50% {
        border-radius: 56% 44% 33% 67% / 45% 67% 33% 55%;
      }

      75% {
        border-radius: 38% 62% 56% 44% / 62% 38% 62% 38%;
      }
    }

    @keyframes morph-3 {

      0%,
      100% {
        border-radius: 38% 62% 63% 37% / 41% 44% 56% 59%;
      }

      33% {
        border-radius: 62% 38% 43% 57% / 72% 28% 72% 28%;
      }

      66% {
        border-radius: 51% 49% 70% 30% / 61% 39% 61% 39%;
      }
    }

    @keyframes morph-4 {

      0%,
      100% {
        border-radius: 36% 64% 27% 73% / 48% 27% 73% 52%;
      }

      20% {
        border-radius: 73% 27% 59% 41% / 57% 59% 41% 43%;
      }

      40% {
        border-radius: 46% 54% 50% 50% / 35% 61% 39% 65%;
      }

      60% {
        border-radius: 50% 50% 33% 67% / 55% 27% 73% 45%;
      }

      80% {
        border-radius: 29% 71% 56% 44% / 69% 56% 44% 31%;
      }
    }

    @keyframes morph-5 {

      0%,
      100% {
        border-radius: 41% 59% 41% 59% / 41% 59% 41% 59%;
      }

      25% {
        border-radius: 69% 31% 62% 38% / 47% 72% 28% 53%;
      }

      50% {
        border-radius: 34% 66% 25% 75% / 63% 37% 63% 37%;
      }

      75% {
        border-radius: 58% 42% 72% 28% / 42% 58% 42% 58%;
      }
    }

    .window-container {
      position: relative;
      width: 100%;
      height: 100vh;
      overflow: hidden;
    }


    .window {
      position: absolute;
      background-color: #FFFEE8;
      border: 4px solid var(--outline-color);

      border-radius: 15px;

      box-shadow: 7px 10px var(--outline-color);
      overflow: hidden;
      /* Add will-change for better performance */
      will-change: transform;
      /* Smooth transitions for the tilt effect */
      transition: transform 0.15s ease-out, box-shadow 0.1s ease;

      display: flex;
      flex-direction: column;
    }

    .window.dragging {
      cursor: grabbing !important;
      box-shadow: 17px 25px var(--outline-color);
      /*box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);*/
    }

    .window-titlebar {
      background: #FFFEE8;
      border-bottom: 4px solid var(--outline-color);
      color: var(--outline-color);
      padding: 10px;
      cursor: move;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .window-titlebar:hover {
      background: #FFF5CC;
      transition: 0.3s ease-in-out;
    }

    .window.dragging .window-titlebar {
      background: #FFF5CC;
    }

    .window-title {
      flex-grow: 1;
      text-align: center;
      font-weight: 500;
    }

    .window-controls {
      display: flex;
      gap: 8px;
      margin-left: auto;
      padding-left: 4px;
    }

    .window-close {
      width: 20px;
      height: 20px;

      border: 3px solid var(--outline-color);
      border-radius: 50%;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .window-close:hover {
      background-color: #FECECE;
    }

    .window-content {
      padding: 20px;
      flex: 1;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      overflow: scroll;
    }

    .window-content:has(.explorer-container) {
      overflow: hidden;
      padding: 0;
    }


    .window.active {}

    .folder {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s ease-in-out;
    }

    .folder:hover {
      transform: scale(1.1);
    }

    /* Loading spinner for HTMX */
    .htmx-request .spawn-button {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .htmx-request .spawn-button::after {
      content: "...";
    }

    #windows-area {
      position: absolute;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    #windows-area>* {
      pointer-events: auto;
    }
  </style>


  <script>
    let draggedElement = null;
    let offsetX = 0;
    let offsetY = 0;
    let highestZIndex = 1000;
    let dragVelocityX = 0;
    let velocityHistory = [];
    let currentRotation = 0;


    document.addEventListener('DOMContentLoaded', function () {
      // Convert all windows to pixel positioning on load
      document.querySelectorAll('.window').forEach(window => {
        const rect = window.getBoundingClientRect();
        window.style.transform = 'none';
        window.style.left = rect.left + 'px';
        window.style.top = rect.top + 'px';
        window.style.right = 'auto';
        window.style.bottom = 'auto';
      });


      document.body.addEventListener('htmx:configRequest', function (evt) {
        evt.detail.headers['X-Highest-Z-Index'] = highestZIndex;

        // DEBUG: Log the header being sent
        console.log('Sending HTMX request with headers:', {
          url: evt.detail.path,
          'X-Highest-Z-Index': highestZIndex,
          allHeaders: evt.detail.headers
        });
      });
    });

    // Use event delegation for dynamically added windows
    document.addEventListener('mousedown', function (e) {
      if (e.target.closest('.window-titlebar')) {
        startDrag(e);
      } else if (e.target.closest('.folder')) {
      }
    });

    function startDrag(e) {
      draggedElement = e.target.closest('.window');
      if (!draggedElement) return;

      const rect = draggedElement.getBoundingClientRect();

      // Switch to pixel positioning for drag
      draggedElement.style.left = rect.left + 'px';
      draggedElement.style.top = rect.top + 'px';

      offsetX = e.clientX - rect.left;
      offsetY = e.clientY - rect.top;

      draggedElement.classList.add('dragging');

      // Reset velocity tracking
      velocityHistory = [];
      currentRotation = 0;

      draggedElement.style.transform = 'scale(1.02) rotate(0deg)';

      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', stopDrag);

      // Bring element to front
      highestZIndex++;
      draggedElement.style.zIndex = highestZIndex;

      // Active window class
      document.querySelectorAll('.window').forEach(w => w.classList.remove('active'));
      draggedElement.classList.add('active');

      e.preventDefault();
    }

    function drag(e) {
      if (!draggedElement) return;

      let x = e.clientX - offsetX;
      let y = e.clientY - offsetY;

      // Keep window within viewport bounds
      x = Math.max(0, Math.min(x, window.innerWidth - draggedElement.offsetWidth));
      y = Math.max(0, Math.min(y, window.innerHeight - draggedElement.offsetHeight));

      // Calculate velocity
      const currentX = e.clientX;
      const now = Date.now();

      // Track velocity over last few frames for smoothing
      velocityHistory.push({x: currentX, time: now});

      // Keep only recent history (last 100ms)
      velocityHistory = velocityHistory.filter(v => now - v.time < 100);

      // Calculate average velocity
      if (velocityHistory.length > 1) {
        const oldest = velocityHistory[0];
        const deltaX = currentX - oldest.x;
        const deltaTime = now - oldest.time;
        dragVelocityX = deltaTime > 0 ? (deltaX / deltaTime) * 16 : 0; // Normalize to ~60fps
      }

      // Smooth rotation based on velocity
      // Use a dead zone to prevent jitter at low speeds
      let targetRotation = 0;
      const deadZone = 0.5; // Adjust this value to control sensitivity

      if (Math.abs(dragVelocityX) > deadZone) {
        // Clamp rotation between -5 and 5 degrees
        targetRotation = Math.max(-4, Math.min(4, dragVelocityX * 0.5));
      }

      // Smooth interpolation to target rotation
      currentRotation += (targetRotation - currentRotation) * 0.3;

      // Apply position and rotation
      draggedElement.style.left = x + 'px';
      draggedElement.style.top = y + 'px';
      draggedElement.style.transform = `scale(1.02) rotate(${currentRotation}deg)`;
    }

    function stopDrag() {
      document.removeEventListener('mousemove', drag);
      document.removeEventListener('mouseup', stopDrag);

      if (!draggedElement) return;

      draggedElement.classList.remove('dragging');

      // Smooth return to normal state
      draggedElement.style.transform = 'scale(1) rotate(0deg)';

      // Reset tracking variables
      velocityHistory = [];
      currentRotation = 0;
      draggedElement = null;
    }

    // Handle window activation on click
    document.addEventListener('click', function (e) {
      const window = e.target.closest('.window');
      if (window) {
        document.querySelectorAll('.window').forEach(w => w.classList.remove('active'));
        window.classList.add('active');
        highestZIndex++;
        window.style.zIndex = highestZIndex;
      }
    });

  </script>
</head>

<body>
  <div class="window-container" , id="main-window-container">

    <div class="lava-lamp-container">
      <div class="lava-blob blob-1"></div>
      <div class="lava-blob blob-2"></div>
      <div class="lava-blob blob-3"></div>
      <div class="lava-blob blob-4"></div>
      <div class="lava-blob blob-5"></div>
      <div class="lava-blob blob-6"></div>
    </div>
    <div id="windows-area">
      {{range .Windows}}
      {{template "window" .}}
      {{end}}
    </div>
    <div class="desktop-icons">
      <!--Add new icon apps here-->
      {{range .Folders}}
      {{template "folder" .}}
      {{end}}
    </div>
  </div>

</body>

</html>
