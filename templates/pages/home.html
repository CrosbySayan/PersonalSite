<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Window Manager</title>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #FFDCB3;
      font-family: 'JetBrains Mono', monospace;
      min-height: 100vh;
    }

    :root {
      --outline-color: #282828;
      --secondary-color: #e74c3c;
      --brand-purple: #6c5ce7;
    }

    .window-container {
      position: relative;
      width: 100%;
      height: 100vh;
      overflow: hidden;
    }


    .window {
      position: absolute;
      background-color: #FFFEE8;
      border: 4px solid var(--outline-color);

      border-radius: 15px;

      box-shadow: 7px 10px var(--outline-color);
      overflow: hidden;
      /* Add will-change for better performance */
      will-change: transform;
      /* Smooth transitions for the tilt effect */
      transition: transform 0.15s ease-out, box-shadow 0.1s ease;

      display: flex;
      flex-direction: column;
    }

    .window.dragging {
      cursor: grabbing !important;
      box-shadow: 17px 25px var(--outline-color);
      /*box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);*/
    }

    .window-titlebar {
      background: #FFFEE8;
      border-bottom: 4px solid var(--outline-color);
      color: var(--outline-color);
      padding: 10px;
      cursor: move;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .window-titlebar:hover {
      background: #FFF5CC;
      transition: 0.3s ease-in-out;
    }

    .window.dragging .window-titlebar {
      background: #FFF5CC;
    }

    .window-title {
      flex-grow: 1;
      text-align: center;
      font-weight: 500;
    }

    .window-controls {
      display: flex;
      gap: 8px;
      margin-left: auto;
      padding-left: 4px;
    }

    .window-close {
      width: 20px;
      height: 20px;

      border: 3px solid var(--outline-color);
      border-radius: 50%;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .window-close:hover {
      background-color: #FECECE;
    }

    .window-content {
      padding: 20px;
      flex: 1;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      overflow: scroll;
    }

    .window-content:has(.explorer-container) {
      overflow: hidden;
      padding: 0;
    }


    .window.active {}

    .folder {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s ease-in-out;
    }

    .folder:hover {
      transform: scale(1.1);
    }

    /* Loading spinner for HTMX */
    .htmx-request .spawn-button {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .htmx-request .spawn-button::after {
      content: "...";
    }

    #windows-area {
      position: absolute;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    #windows-area>* {
      pointer-events: auto;
    }
  </style>


  <script>
    let draggedElement = null;
    let offsetX = 0;
    let offsetY = 0;
    let highestZIndex = 1000;
    let dragVelocityX = 0;
    let velocityHistory = [];
    let currentRotation = 0;

    document.addEventListener('DOMContentLoaded', function () {
      // Convert all windows to pixel positioning on load
      document.querySelectorAll('.window').forEach(window => {
        const rect = window.getBoundingClientRect();
        window.style.transform = 'none';
        window.style.left = rect.left + 'px';
        window.style.top = rect.top + 'px';
        window.style.right = 'auto';
        window.style.bottom = 'auto';
      });
    });

    // Use event delegation for dynamically added windows
    document.addEventListener('mousedown', function (e) {
      if (e.target.closest('.window-titlebar')) {
        startDrag(e);
      } else if (e.target.closest('.folder')) {
        console.log("test")
      }
    });

    function startDrag(e) {
      draggedElement = e.target.closest('.window');
      if (!draggedElement) return;

      const rect = draggedElement.getBoundingClientRect();

      // Switch to pixel positioning for drag
      draggedElement.style.left = rect.left + 'px';
      draggedElement.style.top = rect.top + 'px';

      offsetX = e.clientX - rect.left;
      offsetY = e.clientY - rect.top;

      draggedElement.classList.add('dragging');

      // Reset velocity tracking
      velocityHistory = [];
      currentRotation = 0;

      draggedElement.style.transform = 'scale(1.02) rotate(0deg)';

      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', stopDrag);

      // Bring element to front
      highestZIndex++;
      draggedElement.style.zIndex = highestZIndex;

      // Active window class
      document.querySelectorAll('.window').forEach(w => w.classList.remove('active'));
      draggedElement.classList.add('active');

      e.preventDefault();
    }

    function drag(e) {
      if (!draggedElement) return;

      let x = e.clientX - offsetX;
      let y = e.clientY - offsetY;

      // Keep window within viewport bounds
      x = Math.max(0, Math.min(x, window.innerWidth - draggedElement.offsetWidth));
      y = Math.max(0, Math.min(y, window.innerHeight - draggedElement.offsetHeight));

      // Calculate velocity
      const currentX = e.clientX;
      const now = Date.now();

      // Track velocity over last few frames for smoothing
      velocityHistory.push({x: currentX, time: now});

      // Keep only recent history (last 100ms)
      velocityHistory = velocityHistory.filter(v => now - v.time < 100);

      // Calculate average velocity
      if (velocityHistory.length > 1) {
        const oldest = velocityHistory[0];
        const deltaX = currentX - oldest.x;
        const deltaTime = now - oldest.time;
        dragVelocityX = deltaTime > 0 ? (deltaX / deltaTime) * 16 : 0; // Normalize to ~60fps
      }

      // Smooth rotation based on velocity
      // Use a dead zone to prevent jitter at low speeds
      let targetRotation = 0;
      const deadZone = 0.5; // Adjust this value to control sensitivity

      if (Math.abs(dragVelocityX) > deadZone) {
        // Clamp rotation between -5 and 5 degrees
        targetRotation = Math.max(-4, Math.min(4, dragVelocityX * 0.5));
      }

      // Smooth interpolation to target rotation
      currentRotation += (targetRotation - currentRotation) * 0.3;

      // Apply position and rotation
      draggedElement.style.left = x + 'px';
      draggedElement.style.top = y + 'px';
      draggedElement.style.transform = `scale(1.02) rotate(${currentRotation}deg)`;
    }

    function stopDrag() {
      document.removeEventListener('mousemove', drag);
      document.removeEventListener('mouseup', stopDrag);

      if (!draggedElement) return;

      draggedElement.classList.remove('dragging');

      // Smooth return to normal state
      draggedElement.style.transform = 'scale(1) rotate(0deg)';

      // Reset tracking variables
      velocityHistory = [];
      currentRotation = 0;
      draggedElement = null;
    }

    // Handle window activation on click
    document.addEventListener('click', function (e) {
      const window = e.target.closest('.window');
      if (window) {
        document.querySelectorAll('.window').forEach(w => w.classList.remove('active'));
        window.classList.add('active');
        highestZIndex++;
        window.style.zIndex = highestZIndex;
      }
    });

    document.body.addEventListener('htmx:configRequest', function (evt) {
      evt.detail.headers['X-Highest-Z-Index'] = highestZIndex;
      highestZIndex++;
    });
  </script>
</head>

<body>

  <div class="window-container" , id="main-window-container">
    <div id="windows-area">
      {{range .Windows}}
      {{template "window" .}}
      {{end}}
    </div>
    <div class="desktop-icons">
      <!--Add new icon apps here-->
      {{range .Folders}}
      {{template "folder" .}}
      {{end}}
    </div>
  </div>

</body>

</html>
